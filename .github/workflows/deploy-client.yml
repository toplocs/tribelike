name: Deploy Client to GitHub Pages

on:
  # Runs on pushes to main branch
  push:
    branches: [main]
  # Allows manual triggering with custom base path
  workflow_dispatch:
    inputs:
      base_path:
        description: 'Custom base path (e.g., /my-app). Leave empty for auto-detection'
        required: false
        type: string
        default: ''
      gun_peers:
        description: 'Gun.js peer URLs (comma-separated). Leave empty for no peers'
        required: false
        type: string
        default: ''
      debug_mode:
        description: 'Enable Gun.js debug logging (true/false). Adds ?debug=true to deployment'
        required: false
        type: boolean
        default: false

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: Install dependencies
        run: pnpm install
        
      - name: Build project
        run: |
          # Automatically set base path for GitHub Pages
          # - For custom domains or user/org pages (*.github.io): use root path "/"
          # - For project pages: use repository name as base path
          # - Allow override via workflow input
          
          if [[ -n "${{ github.event.inputs.base_path }}" ]]; then
            # Use custom base path if provided
            export BASE_PATH="${{ github.event.inputs.base_path }}"
          elif [[ "${{ github.event.repository.name }}" == *".github.io" ]]; then
            # User/org pages use root path
            export BASE_PATH="/"
          else
            # Project pages use repository name
            export BASE_PATH="/${{ github.event.repository.name }}"
          fi
          
          echo "üîß Building with BASE_PATH=${BASE_PATH}"
          
          # Set Gun.js peers if provided
          if [[ -n "${{ github.event.inputs.gun_peers }}" ]]; then
            export VITE_GUN_PEERS="${{ github.event.inputs.gun_peers }}"
            echo "üî´ Using Gun peers: ${VITE_GUN_PEERS}"
          else
            export VITE_GUN_PEERS=""
            echo "üî´ No Gun peers configured (local storage only)"
          fi
          
          # Set debug mode if requested
          if [[ "${{ github.event.inputs.debug_mode }}" == "true" ]]; then
            export VITE_DEBUG_MODE="true"
            echo "üêõ Debug mode enabled"
          fi
          
          # Build client without TypeScript checking due to upstream type errors
          # This is temporary until type issues are resolved in the main codebase
          pnpm run -F client build-only
          
          # Build server (required for serving the client)
          pnpm run -F server build
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload client build output
          path: ./client/server/src/views

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Deployment URLs
        run: |
          echo "üöÄ Deployment Complete!"
          echo "====================="
          
          # Display the deployment URL based on repository type
          if [[ "${{ github.event.repository.name }}" == *".github.io" ]]; then
            # User/Org GitHub Pages site (e.g., username.github.io)
            echo "üìç Your site is live at: https://${{ github.repository_owner }}.github.io/"
          else
            # Project GitHub Pages site
            echo "üìç Your site is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi
          
          echo ""
          echo "üí° Note: If you have a custom domain configured in GitHub Pages settings,"
          echo "   your site will be available at that domain instead."
          echo "====================="